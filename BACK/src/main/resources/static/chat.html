<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="_csrf" content="${_csrf.token}">
    <meta name="_csrf_header" content="X-CSRF-TOKEN">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }
        #chat-list {
            width: 30%;
            border-right: 1px solid #ccc;
            padding: 10px;
        }
        #chat-room {
            width: 70%;
            padding: 10px;
        }
        #messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            margin-top: 10px;
            padding: 10px;
        }
        .message {
            margin: 5px 0;
        }
        #chat-room.hidden {
            display: none;
        }
        #new-room-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<!-- 채팅 목록 -->
<div id="chat-list">
    <h2>채팅 목록</h2>
    <button onclick="openNewRoomModal()">새 채팅 +</button>
    <ul id="room-list"></ul>
</div>

<!-- 채팅방 -->
<div id="chat-room" class="hidden">
    <h2 id="room-name">채팅방</h2>
    <div id="messages"></div>
    <input id="message" type="text" placeholder="메시지를 입력하세요..." />
    <button onclick="sendMessage()">전송</button>
</div>

<!-- 새 채팅방 생성 모달 -->
<div id="new-room-modal">
    <h3>새 채팅방 만들기</h3>
    <input id="room-name-input" type="text" placeholder="채팅방 이름" />
    <h4>채팅에 초대할 지점 선택:</h4>
    <ul id="store-list">
        <!-- DB에 저장된 store 목록 렌더링 -->
    </ul>
    <button onclick="createRoom()">생성</button>
    <button onclick="closeNewRoomModal()">취소</button>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;

    // WebSocket 연결
    function connect() {
        const socket = new SockJS('http://localhost:8080/chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 채팅방 목록 구독
            stompClient.subscribe('/topic/rooms', function (rooms) {
                renderRoomList(JSON.parse(rooms.body));
            });

            // 메시지 구독
            stompClient.subscribe('/topic/room/' + currentRoomId, function (message) {
                showMessage(JSON.parse(message.body));
            });
        });
    }

    window.onload = function() {
        connect();
        loadRooms();
        loadStores();
    };

    // 채팅방 생성 모달 열기
    function openNewRoomModal() {
        document.getElementById('new-room-modal').style.display = 'block';
    }

    // 채팅방 생성 모달 닫기
    function closeNewRoomModal() {
        document.getElementById('new-room-modal').style.display = 'none';
    }

    // 채팅방 목록 불러오기
    function loadRooms() {
        fetch('/chat/rooms')
            .then(response => response.json())
            .then(data => renderRoomList(data));
    }

    // 채팅방 목록 렌더링
    function renderRoomList(rooms) {
        const roomList = document.getElementById('room-list');
        roomList.innerHTML = '';
        rooms.forEach(room => {
            const li = document.createElement('li');
            li.textContent = room.name;
            li.onclick = () => openRoom(room.id, room.name);
            roomList.appendChild(li);
        });
    }

    // 스토어 목록 불러오기
    function loadStores() {
        fetch('/chat/stores')
            .then(response => response.json())
            .then(stores => renderStoreList(stores));
    }

    // 스토어 목록 렌더링
    function renderStoreList(stores) {
        const storeList = document.getElementById('store-list');
        storeList.innerHTML = '';
        stores.forEach(store => {
            const li = document.createElement('li');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = store.id;
            const label = document.createElement('label');
            label.textContent = store.storeName;
            li.appendChild(checkbox);
            li.appendChild(label);
            storeList.appendChild(li);
        });
    }

    // 채팅방 열기
    function openRoom(roomId, roomName) {
        currentRoomId = roomId;
        document.getElementById('chat-room').classList.remove('hidden');
        document.getElementById('room-name').textContent = roomName;

        // 이전 메시지 로드
        fetch(`/chat/room/${roomId}/messages`)
            .then(response => response.json())
            .then(messages => {
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                messages.forEach(message => showMessage(message));
            });
    }

    // 새 채팅방 생성
    function createRoom() {
        const roomName = document.getElementById('room-name-input').value;
        const selectedStores = Array.from(document.querySelectorAll('#store-list input:checked'))
            .map(input => input.value);

        // CSRF 토큰을 헤더에 포함
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch('/chat/createRoom', {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: roomName, stores: selectedStores })
        }).then(() => {
            closeNewRoomModal();
            loadRooms();
        });
    }

    // 메시지 전송
    function sendMessage() {
        const message = {
            sender: 'User1', // 추후 로그인 사용자로 대체
            content: document.getElementById('message').value
        };
        stompClient.send(`/app/room/${currentRoomId}/send`, {}, JSON.stringify(message));
        document.getElementById('message').value = '';
    }

    // 메시지 표시
    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `<div class="message"><strong>${message.sender}:</strong> ${message.content}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
